<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localization Data Viewer</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body oncontextmenu="return false;">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/102/three.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.2/TweenMax.min.js"></script>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="see_molecules.js"></script>
    
    <div id="drop-area" ondrop = "handleDrop(event)">
        <input type="file" id="fileElem" onchange="uploadFile(this.file)">
      </div>

    <div id = 'controls'><p><u>Controls</u><br />
        w = move forward<br /> a = move left<br /> s = move backward<br /> d = move right<br /> r =reset<br />
        right click = rotate camera<br /> left click = rotate object<br /> White cross is 1&mu;m x 1&mu;m x 1&mu;m
    </p>
    </div>
    
    <div id='legend'>
        <u>Legend</u><br/>
        Red: <span id='red_legend_text'></span><br/>
        Orange: <span id='orange_legend_text'></span>
    </div>
      

    <div id = 'example-buttons'>
    <button type="button" onclick="load_dataset_1()">Load Non-Stim GPI/vGlut</button>
    <button type="button" onclick="load_dataset_2()">Load Stimulated GPI/vGlut 1</button>
    <button type="button" onclick="load_dataset_3()">Load Stimulated GPI/vGlut 2</button>
    <button type="button" onclick="load_dataset_4()">Load Stimulated GPI/vGlut 3</button>
    </div>

    <div id='toggles'>
    <button type="button" onclick="toggle_red()"><span id="red_button_text"></span></button>
    <button type="button" onclick="toggle_orange()"><span id="orange_button_text"></span></button>
    <button type="button" onclick="show_both_colors()">Show Both Colors</button>
    </div>

    <div id='cell-title'>
        <span id="title"></span> Dataset
    </div>
    
    <div id ='describe'>
        <u>Info</u><br/>
        <span id="description"></span>
    </div>

    <div id ='file_load'>You can load a file by dragging and dropping onto the page</div>

    <script>

        // testing python funcationality
        //runPython()
        /*const fileSelector = document.getElementById("file")
        
        fileSelector.addEventListener('change',(e) =>{
        disp(e.target.files);
        })*/
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000)
        camera.position.z = 10;

        
        var renderer = new THREE.WebGLRenderer({andtialias: true});
        renderer.setClearColor("#00000");
        renderer.setSize(window.innerWidth,window.innerHeight);
        
        document.body.appendChild(renderer.domElement);
        
        document.getElementById('title').innerHTML = 'Non-Stimulated Neuron';
        var light = new THREE.PointLight(0xFFFFFF, 1 , 500);
        light.position.set(10,0,25);
        scene.add(light)
        load_dataset_1();
        document.getElementById('red_button_text').innerHTML = 'Hide Red Localizations';
        document.getElementById('orange_button_text').innerHTML = 'Hide Orange Localizations';
        var circle_size = 6;
        // Toggling variables for multi-color display (used in showing 1 color at a time)
        var red_on = 1;
        var orange_on = 1;
        function load_dataset_1(){
            var quick_description = 'This is an example of a neuron without much drift, sitting in Tyrodes(with glucose) and no stimulation'
            clear_scene();
            camera_reset();
            document.getElementById('title').innerHTML = 'Non-Stimulated Neuron';
            document.getElementById('description').innerHTML = quick_description;
            document.getElementById('orange_legend_text').innerHTML = 'vGlut-mEos';
            document.getElementById('red_legend_text').innerHTML = 'GPI-Halo';
            build_new_scene("1_red.txt",1);
            build_new_scene("1_orange.txt",2);
        }
        function load_dataset_2(){
            clear_scene();
            camera_reset();
            var quick_description = 'This is an example of a neuron without much drift, sitting in Tyrodes(with deoxyglucose) for over 5 minutes after 600 AP at 10 Hz';
            document.getElementById('title').innerHTML = 'Stimulated Neuron';
            document.getElementById('description').innerHTML = quick_description;
            document.getElementById('orange_legend_text').innerHTML = 'vGlut-mEos';
            document.getElementById('red_legend_text').innerHTML = 'GPI-Halo';
            build_new_scene("2_red.txt",1)
            build_new_scene("2_orange.txt",2)
        }
        function load_dataset_3(){
            clear_scene();
            camera_reset();
            document.getElementById('title').innerHTML = 'Stimulated Neuron';
            document.getElementById('description').innerHTML = 'This is an example of a neuron without much drift, sitting in Tyrodes(with deoxyglucose) for over 5 minutes after 600 AP at 10 Hz';
            document.getElementById('orange_legend_text').innerHTML = 'vGlut-mEos';
            document.getElementById('red_legend_text').innerHTML = 'GPI-Halo';
            build_new_scene("3_red.txt",1)
            build_new_scene("3_orange.txt",2)
        }
        function load_dataset_4(){
            clear_scene();
            camera_reset();
            document.getElementById('title').innerHTML = 'Stimulated Neuron';
            document.getElementById('description').innerHTML = 'This is an example of a neuron without much drift, sitting in Tyrodes(with deoxyglucose) for over 5 minutes after 600 AP at 10 Hz';
            document.getElementById('orange_legend_text').innerHTML = 'vGlut-mEos';
            document.getElementById('red_legend_text').innerHTML = 'GPI-Halo';
            build_new_scene("4_red.txt",1)
            build_new_scene("4_orange.txt",2)
        }
        function load_dataset_drift(){
            clear_scene();
            camera_reset();
            document.getElementById('title').innerHTML = 'Example of Drift in early sets';
            document.getElementById('description').innerHTML = 'This is an example of a neuron with much drift, sitting in Tyrodes(with glucose) and no stimulation';
            document.getElementById('orange_legend_text').innerHTML = 'vGlut-mEos';
            document.getElementById('red_legend_text').innerHTML = 'GPI-Halo';
            build_new_scene("drift_red.txt",1)
            build_new_scene("drift_orange.txt",2)
        }
        function clear_scene(){
            while(scene.children.length >0){
            // clear the scene
                scene.remove(scene.children[0]);
            }
            scene.add(light);
            build_scale();
        }
        function build_new_scene(stringName,color)
        {
            Text = readTextFile(stringName);
            [x, y, z] = parse_data(Text);
            if (color == 1){
                // Red color
                red_mesh = build_new_geometry(x, y, z,0.02);
                scene.add(red_mesh)
            }else{
                // orange color
                orange_mesh = build_new_geometry(x, y, z,0.025);
                scene.add(orange_mesh)
            }
        }    
        function build_scale(){
            // build a 3D cross of unit length centered at the origin
            on_axis = 1; // 1 micron length
            off_axis = 0.05 // 'thickness'
            var x_dash = new THREE.BoxGeometry(on_axis,off_axis, off_axis);
            var y_dash = new THREE.BoxGeometry(off_axis, on_axis, off_axis);
            var z_dash = new THREE.BoxGeometry(off_axis, off_axis, on_axis);
            var material = new THREE.MeshLambertMaterial( {color: 0xffffff} );
            var dash = new THREE.Mesh( x_dash, material);
            scene.add( dash);
            var dash = new THREE.Mesh( y_dash, material);
            scene.add( dash);
            var dash = new THREE.Mesh( z_dash, material);
            scene.add( dash);
            
        }   
            
        function build_new_geometry(x,y,z, radius)
        {// function to build a geomtry and return the mesh
            var final_geometry = new THREE.Geometry();
            
            for (i=0; i<x.length; i++)
            {// loop over all molecules and add them to the geometry
                var geometry = new THREE.SphereGeometry( radius,circle_size,circle_size);
            //var material = new THREE.MeshLambertMaterial({color : 0xFFCC00});
            var mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(x[i], y[i], z[i]);
            mesh.updateMatrix();
            final_geometry.merge(mesh.geometry, mesh.matrix);
            }
            if(radius == 0.025){// 0.025 is radius of a vesicle meaning orange
                
                var material = new THREE.MeshLambertMaterial({color : 0xc6ff00});
                return new THREE.Mesh(final_geometry, material)
            }else{
                
                var material = new THREE.MeshLambertMaterial({color : 0xff2b00});
                return new THREE.Mesh(final_geometry, material)
            }
        }
        
        

        renderer.render(scene, camera)
        window.addEventListener('resize', () => {
            renderer.setSize(window.innerWidth,window.innerHeight);
            camera.aspect = window.innerWidth/window.innerHeight;

            camera.updateProjectionMatrix();
        })


        var render = function(){
            requestAnimationFrame(render);
            
            //orange_mesh.rotation.x += 0.01;
            renderer.render(scene, camera);
        }
        render()
        
        
        // drag and drop file section
        let dropArea = document.getElementById('drop-area')
        ;['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false)
        })

        ;['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false)
        })
        

    </script>
</body>
</html>